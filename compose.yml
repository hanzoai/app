version: '3.8'

services:
  # Hanzo AI Build Platform
  hanzo-build:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: ghcr.io/hanzoai/build:latest
    container_name: hanzo-build
    restart: unless-stopped
    
    # Environment configuration
    env_file:
      - .env.production
    environment:
      # Node.js configuration
      - NODE_ENV=production
      - PORT=3000
      
      # Next.js configuration
      - NEXT_PUBLIC_APP_URL=https://hanzo.app
      - NEXTAUTH_URL=https://hanzo.app
      
      # Database
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379}
      
      # Authentication
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - HF_CLIENT_ID=${HF_CLIENT_ID}
      - HF_CLIENT_SECRET=${HF_CLIENT_SECRET}
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET}
      
      # Stripe configuration
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      
      # Other services
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    
    # Network configuration
    networks:
      - hanzo-network
      - internal
    
    # Port mapping (only for local development/testing)
    ports:
      - "3000:3000"
    
    # Traefik labels for automatic HTTPS and routing
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=hanzo-network"
      
      # HTTPS Router
      - "traefik.http.routers.hanzo-build.rule=Host(`hanzo.app`)"
      - "traefik.http.routers.hanzo-build.entrypoints=websecure"
      - "traefik.http.routers.hanzo-build.tls=true"
      - "traefik.http.routers.hanzo-build.tls.certresolver=letsencrypt"
      
      # HTTP to HTTPS redirect
      - "traefik.http.routers.hanzo-build-http.rule=Host(`hanzo.app`)"
      - "traefik.http.routers.hanzo-build-http.entrypoints=web"
      - "traefik.http.routers.hanzo-build-http.middlewares=redirect-to-https"
      
      # Service configuration
      - "traefik.http.services.hanzo-build.loadbalancer.server.port=3000"
      - "traefik.http.services.hanzo-build.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.hanzo-build.loadbalancer.healthcheck.interval=30s"
      
      # Security headers
      - "traefik.http.middlewares.hanzo-build-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.hanzo-build-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.hanzo-build-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.hanzo-build-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.hanzo-build-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.hanzo-build-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.hanzo-build-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.routers.hanzo-build.middlewares=hanzo-build-headers"
      
      # Rate limiting
      - "traefik.http.middlewares.hanzo-build-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.hanzo-build-ratelimit.ratelimit.burst=50"
      - "traefik.http.routers.hanzo-build.middlewares=hanzo-build-headers,hanzo-build-ratelimit"
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: unless-stopped
        delay: 5s
        max_attempts: 3
    
    # Volumes
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    
    # Dependencies
    depends_on:
      - redis
      - postgres

  # Redis cache
  redis:
    image: redis:7-alpine
    container_name: hanzo-build-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    networks:
      - internal
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: hanzo-build-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USER:-hanzo}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME:-hanzo_build}
      - POSTGRES_HOST_AUTH_METHOD=md5
    networks:
      - internal
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-hanzo} -d ${DB_NAME:-hanzo_build}"]
      interval: 10s
      timeout: 5s
      retries: 5

# Networks
networks:
  hanzo-network:
    external: true
    name: hanzo-network
  internal:
    driver: bridge
    internal: true

# Volumes
volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local