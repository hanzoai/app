# Hanzo Desktop App Makefile
# Commands for building and managing the Hanzo desktop application

# Variables
DESKTOP_DIR = apps/hanzo-desktop
TAURI_DIR = $(DESKTOP_DIR)/src-tauri
ICONS_DIR = $(TAURI_DIR)/icons
PYTHON = python3

# Colors for output
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
NC = \033[0m # No Color

.PHONY: help
help: ## Show this help message
	@echo "$(GREEN)Hanzo Desktop App Makefile$(NC)"
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

.PHONY: icons
icons: ## Generate all application icons for macOS, Windows, and Linux
	@echo "$(GREEN)üé® Generating Hanzo icons...$(NC)"
	@cd $(shell pwd) && $(PYTHON) generate_hanzo_icons.py
	@echo "$(GREEN)‚úÖ Icons generated successfully!$(NC)"

.PHONY: icons-check
icons-check: ## Check if required tools for icon generation are installed
	@echo "$(GREEN)Checking icon generation dependencies...$(NC)"
	@which rsvg-convert > /dev/null 2>&1 && echo "‚úÖ rsvg-convert found" || echo "‚ùå rsvg-convert not found - install with: brew install librsvg"
	@which inkscape > /dev/null 2>&1 && echo "‚úÖ inkscape found" || echo "‚ö†Ô∏è  inkscape not found (optional) - install with: brew install inkscape"
	@which convert > /dev/null 2>&1 && echo "‚úÖ ImageMagick found" || echo "‚ùå ImageMagick not found - install with: brew install imagemagick"
	@which iconutil > /dev/null 2>&1 && echo "‚úÖ iconutil found (macOS)" || echo "‚ö†Ô∏è  iconutil not found (only available on macOS)"

.PHONY: install-deps
install-deps: ## Install dependencies for the desktop app
	@echo "$(GREEN)Installing dependencies...$(NC)"
	cd $(DESKTOP_DIR) && pnpm install
	@echo "$(GREEN)‚úÖ Dependencies installed!$(NC)"

.PHONY: dev
dev: ## Run the desktop app in development mode
	@echo "$(GREEN)Starting Hanzo desktop app in development mode...$(NC)"
	cd $(DESKTOP_DIR) && pnpm tauri dev

.PHONY: build
build: icons ## Build the desktop app for production
	@echo "$(GREEN)Building Hanzo desktop app...$(NC)"
	cd $(DESKTOP_DIR) && pnpm tauri build
	@echo "$(GREEN)‚úÖ Build complete!$(NC)"

.PHONY: build-mac
build-mac: icons ## Build the desktop app for macOS only
	@echo "$(GREEN)Building Hanzo desktop app for macOS...$(NC)"
	cd $(DESKTOP_DIR) && pnpm tauri build --target universal-apple-darwin
	@echo "$(GREEN)‚úÖ macOS build complete!$(NC)"

.PHONY: clean
clean: ## Clean build artifacts and generated files
	@echo "$(YELLOW)Cleaning build artifacts...$(NC)"
	rm -rf $(DESKTOP_DIR)/dist
	rm -rf $(TAURI_DIR)/target
	rm -rf $(DESKTOP_DIR)/node_modules/.vite
	@echo "$(GREEN)‚úÖ Cleaned!$(NC)"

.PHONY: clean-icons
clean-icons: ## Clean generated icon files
	@echo "$(YELLOW)Cleaning icon files...$(NC)"
	rm -f $(ICONS_DIR)/*.png
	rm -f $(ICONS_DIR)/*.ico
	rm -f $(ICONS_DIR)/*.icns
	@echo "$(GREEN)‚úÖ Icons cleaned!$(NC)"

.PHONY: regenerate-icons
regenerate-icons: clean-icons icons ## Clean and regenerate all icons

.PHONY: setup-macos
setup-macos: ## Install required tools for icon generation on macOS
	@echo "$(GREEN)Installing icon generation tools for macOS...$(NC)"
	@which brew > /dev/null 2>&1 || (echo "$(RED)Homebrew not found! Please install from https://brew.sh$(NC)" && exit 1)
	brew install librsvg imagemagick
	@echo "$(GREEN)‚úÖ Tools installed!$(NC)"

.PHONY: test
test: ## Run tests for the desktop app
	@echo "$(GREEN)Running tests...$(NC)"
	cd $(DESKTOP_DIR) && pnpm test

.PHONY: lint
lint: ## Run linting for the desktop app
	@echo "$(GREEN)Running linter...$(NC)"
	cd $(DESKTOP_DIR) && pnpm lint

.PHONY: format
format: ## Format code using prettier
	@echo "$(GREEN)Formatting code...$(NC)"
	cd $(DESKTOP_DIR) && pnpm format

.PHONY: update-tauri
update-tauri: ## Update Tauri dependencies
	@echo "$(GREEN)Updating Tauri...$(NC)"
	cd $(DESKTOP_DIR) && pnpm update @tauri-apps/cli @tauri-apps/api

.PHONY: rust-check
rust-check: ## Check Rust code in src-tauri
	@echo "$(GREEN)Checking Rust code...$(NC)"
	cd $(TAURI_DIR) && cargo check

.PHONY: rust-fmt
rust-fmt: ## Format Rust code in src-tauri
	@echo "$(GREEN)Formatting Rust code...$(NC)"
	cd $(TAURI_DIR) && cargo fmt

.PHONY: screenshots
screenshots: ## Generate screenshots for documentation (requires app to be running)
	@echo "$(GREEN)Generating screenshots...$(NC)"
	@echo "$(YELLOW)Note: Make sure the Hanzo app is running first!$(NC)"
	@echo "Screenshots will be saved to assets/"
	@mkdir -p assets/screenshots
	@echo "$(YELLOW)Please manually take screenshots and save them to assets/screenshots/$(NC)"
	@echo "Required screenshots:"
	@echo "  1. Main window (dock icon visible)"
	@echo "  2. Menu bar icon and dropdown"
	@echo "  3. In-app icon usage"
	@echo "  4. Getting started screen"

.PHONY: check-env
check-env: ## Check if the development environment is properly set up
	@echo "$(GREEN)Checking development environment...$(NC)"
	@node --version > /dev/null 2>&1 && echo "‚úÖ Node.js: $$(node --version)" || echo "‚ùå Node.js not found"
	@pnpm --version > /dev/null 2>&1 && echo "‚úÖ pnpm: v$$(pnpm --version)" || echo "‚ùå pnpm not found - install with: npm install -g pnpm"
	@cargo --version > /dev/null 2>&1 && echo "‚úÖ Rust: $$(cargo --version)" || echo "‚ùå Rust not found - install from: https://rustup.rs"
	@rustc --version > /dev/null 2>&1 && echo "‚úÖ rustc: $$(rustc --version)" || echo "‚ùå rustc not found"
	@$(PYTHON) --version > /dev/null 2>&1 && echo "‚úÖ Python: $$($(PYTHON) --version)" || echo "‚ùå Python 3 not found"

.PHONY: all
all: icons build ## Generate icons and build the app

# Default target
.DEFAULT_GOAL := help